version: 2
jobs:
  build:
    machine: true
      services:
        - docker
      docker_layer_caching: true    # default - false
      
    steps:
      - checkout

      - run:
          name: Install dependencies
          command: |
            pip install --user pipenv==8.3.2
            export PATH=$HOME/.local/bin:$PATH
            pipenv install --dev --deploy

      - run:
          name: Start container and verify it's working
          command: |
            export PATH=$HOME/.local/bin:$PATH
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD";
            docker network create rasrmdockerdev_default
            make start_services wait_for_services || docker-compose -f dev.yml -f ras-services.yml -f rm-services.yml logs

      - run:
          name: Run system tests
          command: |
            make system_tests